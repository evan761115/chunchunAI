<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šæ–°èäººç¾¤ç¾¤äºŒä»£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root {
            --primary-color: #940b53; /* Deep Crimson for 'Super' feel */
            --secondary-color: #e53e3e; /* Red Accent */
            --background-light: #f4f6f9;
            --text-dark: #1f2937;
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            min-height: 100vh;
        }
        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 700;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            color: #4b5563;
            font-size: 1rem;
            white-space: nowrap;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: #fef2f2; /* Light red/pink background */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-card {
            /* We will manage formatting with internal divs/p tags */
            text-align: left;
        }
        .powerful-title {
             font-size: 1.6rem;
             font-weight: 900;
             margin-top: 2rem;
             margin-bottom: 0.75rem;
             color: var(--primary-color);
             border-bottom: 3px solid #fbd38d; /* Gold-like separator */
             padding-bottom: 0.25rem;
        }
        .title-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-weight: 700;
            margin-right: 0.75rem;
            min-width: 80px; /* Reduced min-width slightly */
            text-align: center;
        }
        .title-text {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            flex-grow: 1;
        }
        .news-content {
            line-height: 1.8;
            text-align: justify;
        }
        /* New Style for Read-only Input */
        .readonly-input {
            background-color: #f3f4f6;
            cursor: default;
            color: #6b7280;
            font-style: italic;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-8 p-6 bg-white rounded-xl shadow-2xl border-t-8 border-t-red-600">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                âœ¨ è¶…ç´šæ–°èäººç¾¤ç¾¤äºŒä»£
            </h1>
            <p class="text-gray-600 mt-3 font-medium">
                å°ˆç‚ºã€ŠETtodayã€‹é¢¨æ ¼å®šåˆ¶çš„å°ˆæ¥­å…§å®¹ç”Ÿæˆå¼•æ“ã€‚
            </p>
            <p class="text-xs text-red-500 mt-4 font-mono">
                ã€é‡è¦ã€‘è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ API Key æ‰èƒ½ä½¿ç”¨ã€‚
            </p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b mb-6 bg-white rounded-t-xl shadow-lg overflow-x-auto">
            <div id="tab-news" class="tab-button active" data-mode="news" onclick="handleTabSwitch('news')">ä¸€ã€é‡é»è½‰æ–°è</div>
            <div id="tab-rewrite_link" class="tab-button" data-mode="rewrite_link" onclick="handleTabSwitch('rewrite_link')">äºŒã€æ–°èæ”¹å¯«</div>
            <div id="tab-rewrite_pr" class="tab-button" data-mode="rewrite_pr" onclick="handleTabSwitch('rewrite_pr')">ä¸‰ã€é€šç¨¿æ”¹å¯«</div>
            <div id="tab-interview" class="tab-button" data-mode="interview" onclick="handleTabSwitch('interview')">å››ã€è¨ªç¶±ç”Ÿæˆ</div>
        </div>

        <!-- Main Content Area -->
        <div class="space-y-6">

            <!-- Dynamic Input Area -->
            <div id="inputViewContainer" class="p-6 bg-white rounded-xl shadow-2xl min-h-[300px] flex flex-col">
                <!-- Content will be injected here by JS -->
            </div>

            <!-- Results Display -->
            <div id="resultContainer" class="p-6 bg-white rounded-xl shadow-2xl border border-gray-200 min-h-[150px]">
                <div id="loadingIndicator" class="hidden flex justify-center items-center h-full py-10">
                    <div class="loader"></div>
                    <span id="loadingMessage" class="ml-4 text-gray-600">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</span>
                </div>
                <div id="results" class="result-card text-gray-800">
                    <p class="text-center text-gray-500 py-10">è«‹é¸æ“‡åŠŸèƒ½ä¸¦è¼¸å…¥å…§å®¹ä»¥é–‹å§‹ç”Ÿæˆã€‚</p>
                </div>
            </div>
            
            <!-- Citation Display -->
            <div id="citationContainer" class="hidden p-4 bg-gray-100 rounded-lg border border-gray-300">
                <p class="font-semibold text-sm mb-2 text-gray-700">è³‡æ–™ä¾†æº (Grounding Sources):</p>
                <ul id="citationList" class="text-xs text-gray-600 list-disc pl-5 space-y-1"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        // ğŸš¨ ã€é‡è¦ã€‘è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Gemini API Key
        // å¦‚æœæ‚¨åœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼Œè«‹ä¿æŒç‚ºç©º
        const apiKey = "AIzaSyD8qwGksRnr41_B3DO980sD8GzmUbfKet8"; 

        // API URL
        const apiUrlBase = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // DOM å…ƒç´ 
        const inputViewContainer = document.getElementById('inputViewContainer');
        const resultsDiv = document.getElementById('results');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingMessage = document.getElementById('loadingMessage');
        const citationContainer = document.getElementById('citationContainer');
        const citationList = document.getElementById('citationList');
        const tabButtons = document.querySelectorAll('.tab-button');
        
        let currentMode = 'news';
        let isProcessing = false;

        // --- è¼¸å…¥ä»‹é¢æ¨¡æ¿ ---
        const inputTemplates = {
            news: {
                title: 'ä¸€ã€é‡é»è½‰æ–°èï¼šè¼¸å…¥äº‹ä»¶é‡é»æˆ–ç¤¾ç¾¤è²¼æ–‡',
                placeholder: 'è«‹è²¼ä¸Šæ‚¨æƒ³è½‰åŒ–ç‚ºæ–°èç¨¿çš„äº‹ä»¶æ¦‚è¦ã€è¨è«–ä¸²æˆ–è²¼æ–‡...',
                inputTag: 'textarea',
                id: 'newsInput',
                buttonText: 'ğŸ“° ç”Ÿæˆæ–°è',
                buttonClass: 'bg-red-700 hover:bg-red-800 focus:ring-red-300',
                options: true
            },
            rewrite_link: {
                title: 'äºŒã€æ–°èæ”¹å¯«ï¼šå¡«å…¥ä¾†æºèˆ‡åŸæ–‡',
                placeholder: 'è«‹è²¼ä¸Šè¦æ”¹å¯«çš„ã€Œæ–°èå…¨æ–‡ã€æˆ–ã€Œæ–°èé€£çµï¼ˆURLï¼‰ã€ã€‚',
                inputTag: 'textarea',
                id: 'rewriteLinkInput',
                buttonText: 'ğŸ”— é–‹å§‹æ”¹å¯«ä¸¦è£œè¶³å…§å®¹',
                buttonClass: 'bg-indigo-700 hover:bg-indigo-800 focus:ring-indigo-300',
                options: false // Fixed constraints for rewrite
            },
            rewrite_pr: {
                title: 'ä¸‰ã€é€šç¨¿æ”¹å¯«ï¼šè¼¸å…¥å…¬é—œæä¾›ä¹‹æ–°èç¨¿',
                placeholder: 'è«‹è²¼ä¸Šå…¬é—œæä¾›çš„æ–°èç¨¿ä»¶å…§å®¹...',
                inputTag: 'textarea',
                id: 'prInput',
                buttonText: 'ğŸ“ é †ç¨¿æ•´ç†ä¸¦ç”Ÿæˆæ–°è',
                buttonClass: 'bg-green-700 hover:bg-green-800 focus:ring-green-300',
                options: true
            },
            interview: {
                title: 'å››ã€è¨ªç¶±ç”Ÿæˆï¼šè¼¸å…¥è—äººåå–®èˆ‡é‡é»',
                placeholder: 'è«‹è¼¸å…¥è—äººåå–® (ä¾‹å¦‚ï¼šå‘¨æ°å€«ã€è”¡ä¾æ—, æˆ–å–®ä¸€è—äºº)ï¼Œé¸å¡«è¨ªå•é‡é»...',
                inputTag: 'textarea',
                id: 'artistInput',
                buttonText: 'ğŸ¤ æœå°‹äº‹ä»¶ä¸¦ç”Ÿæˆ 20 é¡Œè¨ªç¶±',
                buttonClass: 'bg-purple-700 hover:bg-purple-800 focus:ring-purple-300',
                options: false
            }
        };

        // --- Tab åˆ‡æ›é‚è¼¯ ---
        window.handleTabSwitch = function(mode) {
            currentMode = mode;
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            renderInputView(mode);
            resultsDiv.innerHTML = '<p class="text-center text-gray-500 py-10">å·²åˆ‡æ›æ¨¡å¼ï¼Œè«‹è¼¸å…¥å…§å®¹é–‹å§‹ç”Ÿæˆã€‚</p>';
            citationContainer.classList.add('hidden');
        }

        // --- æ¸²æŸ“è¼¸å…¥ä»‹é¢ ---
        function renderInputView(mode) {
            const template = inputTemplates[mode];
            let inputElement;

            // Common Text Area / Input
            inputElement = template.inputTag === 'textarea' ?
                `<textarea id="${template.id}" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150" placeholder="${template.placeholder}"></textarea>` :
                `<input type="text" id="${template.id}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150" placeholder="${template.placeholder}">`;
            
            // Source Input for Mode 2
            let sourceInput = '';
            if (mode === 'rewrite_link') {
                sourceInput = `
                    <div class="mt-4">
                        <label for="sourceName" class="block text-sm font-medium text-gray-700 mb-1">æ–°èä¾†æº (ä¾‹å¦‚ï¼šä¸‰ç«‹æ–°èç¶²ã€ETtodayã€é¡é€±åˆŠ)</label>
                        <input type="text" id="sourceName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="è«‹å¡«å…¥è¦æ”¹å¯«çš„åŸå§‹æ–°èåª’é«”åç¨±æˆ–é€£çµä¾†æº">
                    </div>
                    <div class="mt-4">
                        <label for="rewriteLinkInput" class="block text-sm font-medium text-gray-700 mb-1">æ–°èå…¨æ–‡æˆ–é€£çµ</label>
                        <textarea id="rewriteLinkInput" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="${template.placeholder}"></textarea>
                    </div>
                `;
                inputElement = ''; // Clear default input for mode 2
            }

            // Options for Modes 1 and 3 (Paragraph Count Selection and Word Count Estimate Display)
            let optionsHtml = '';
            if (template.options) {
                optionsHtml = `
                    <div class="flex space-x-4 mt-4">
                        <div class="flex-1">
                            <label for="paragraphCount" class="block text-sm font-medium text-gray-700 mb-1">âœ… é¸æ“‡ç¸½æ®µè½æ•¸ (P1 + N æ®µ)</label>
                            <select id="paragraphCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                                <option value="3">3 æ®µ (çŸ­æ–‡)</option>
                                <option value="4" selected>4 æ®µ (æ¨™æº–)</option>
                                <option value="5">5 æ®µ (ä¸­é•·)</option>
                                <option value="7">7 æ®µ (é•·ç¯‡)</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="wordCountDisplay" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ é ä¼°ç¸½å­—æ•¸ (ä¾é¸æ“‡æ®µæ•¸è¨ˆç®—)</label>
                            <input type="text" id="wordCountDisplay" class="w-full p-3 border border-gray-300 rounded-lg readonly-input" readonly>
                        </div>
                    </div>
                `;
            }
            
            inputViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-900">${template.title}</h2>
                ${sourceInput || inputElement}
                ${optionsHtml}
                <button onclick="generateContent('${mode}')" id="actionButton" class="w-full mt-6 text-white font-bold py-3 rounded-lg transition duration-200 focus:outline-none focus:ring-4 ${template.buttonClass}">
                    ${template.buttonText}
                </button>
            `;

            // ã€æ®µè½æ•¸/å­—æ•¸é¡¯ç¤ºé‚è¼¯ã€‘
            if (template.options) {
                const parCountSelect = document.getElementById('paragraphCount');
                const wordCountDisplay = document.getElementById('wordCountDisplay');
                
                // Helper to calculate word count range based on P count
                const getWordCountEstimate = (pCount) => {
                    const p = parseInt(pCount);
                    if (p === 3) return 'ç´„ 400 - 500 å­—'; // P1: ~140, P2+P3: 260~400
                    if (p === 4) return 'ç´„ 600 - 750 å­—'; // P1: ~140, P2-P4: 390~600
                    if (p === 5) return 'ç´„ 750 - 950 å­—';
                    if (p === 7) return 'ç´„ 1100 - 1400 å­—';
                    return 'N/A';
                };

                if (parCountSelect && wordCountDisplay) {
                    const updateDisplay = () => {
                        const count = parCountSelect.value;
                        wordCountDisplay.value = getWordCountEstimate(count);
                    };

                    parCountSelect.addEventListener('change', updateDisplay);
                    
                    // Initial update
                    updateDisplay();
                }
            }
        }


        // --- API å‘¼å«èˆ‡é‡è©¦é‚è¼¯ (æ¡ç”¨å¼·åŒ–ç‰ˆæœ¬) ---
        async function fetchWithRetry(url, options, maxRetries = 7, delay = 2000) { 
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.status !== 503) {
                        return response;
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                }
                const waitTime = delay * Math.pow(2, i);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            throw new Error('API è«‹æ±‚åœ¨ 7 æ¬¡é‡è©¦å¾Œä»å¤±æ•—ã€‚éŒ¯èª¤: ä¼ºæœå™¨å¿™ç¢Œ (503) æˆ–æµé‡é™åˆ¶ (429)ã€‚');
        }

        // --- ä¸»è¦å…§å®¹ç”Ÿæˆå‡½æ•¸ ---
        window.generateContent = async function(mode) {
            if (isProcessing) return;

            let inputContent = '';
            let sourceName = '';
            let paragraphCount = 4;
            let systemInstruction = '';
            let payload = {};
            let isGroundingEnabled = false;

            // 1. ç²å–æ‰€æœ‰è¼¸å…¥å’Œé¸é …
            if (mode === 'rewrite_link') {
                inputContent = document.getElementById('rewriteLinkInput').value.trim();
                sourceName = document.getElementById('sourceName').value.trim() || 'æŸçŸ¥ååª’é«”';
                if (!inputContent) { displayError('è«‹è¼¸å…¥æ–°èå…¨æ–‡æˆ–é€£çµã€‚'); return; }
            } else if (mode === 'news' || mode === 'rewrite_pr' || mode === 'interview') {
                const elementId = inputTemplates[mode].id;
                inputContent = document.getElementById(elementId).value.trim();
                if (!inputContent) { displayError('è«‹è¼¸å…¥å…§å®¹ã€‚'); return; }
            }

            if (inputTemplates[mode].options) {
                // å¾ç”¨æˆ¶é¸æ“‡çš„ä¸‹æ‹‰é¸å–®ä¸­ç²å–æ®µè½æ•¸
                paragraphCount = document.getElementById('paragraphCount').value;
            }

            // 2. æ ¹æ“šæ¨¡å¼è¨­å®šæç¤ºå’Œåƒæ•¸
            switch(mode) {
                case 'news':
                    isGroundingEnabled = true;
                    loadingMessage.textContent = 'æ­£åœ¨ä»¥ã€ŠETtodayã€‹é¢¨æ ¼ç”Ÿæˆæ–°èèˆ‡å…­æ¨™é¡Œ...';
                    systemInstruction = `ä½ æ˜¯å°ˆæ¥­çš„å¨›æ¨‚æ–°èç·¨è¼¯ï¼Œæ’°ç¨¿é¢¨æ ¼å¿…é ˆæ¨¡ä»¿ã€Šä¸‰ç«‹æ–°èç¶²ã€‹è¨˜è€…è”¡ç¶­æ­†æˆ–ã€ŠETtodayæ–°èé›²ã€‹è¨˜è€…ç”°æšç‘‹çš„ç­†æ³•ï¼šèªæ°£ç”Ÿå‹•ã€ç¯€å¥æ˜å¿«ã€å¤§é‡ä½¿ç”¨å•è™Ÿæˆ–é©šå˜†è©ã€å…§å®¹å…·å‚™è¡æ“Šæ€§ã€‚
                    
                    è«‹æ ¹æ“šä»¥ä¸‹åš´æ ¼è¦æ±‚è¼¸å‡ºï¼š
                    1. ç¸½æ®µè½æ•¸ï¼š**${paragraphCount}** æ®µã€‚
                    2. é¦–æ®µå­—æ•¸ï¼š**ä¸è¶…é 140 å­—**ã€‚
                    3. å…¶é¤˜æ®µè½å­—æ•¸ï¼š**ä»‹æ–¼ 130 å­—è‡³ 200 å­—ä¹‹é–“**ã€‚
                    
                    è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹å…­ç¨®æ¨™é¡Œåˆ†é¡å’Œä¸€ç¯‡æ–°èç¨¿å…§å®¹ä¾†è¼¸å‡ºçµæœï¼Œä½¿ç”¨ Markdown æ ¼å¼ï¼š
                    
                    ### æ¨™é¡Œåˆ—è¡¨ (Title List)
                    1. æ­£å¸¸å¨›æ¨‚æ¨™é¡Œ (é•·æ¨™ï¼Œç´„ 25 å­—): 
                    2. æ­£å¸¸å¨›æ¨‚æ¨™é¡Œ (çŸ­æ¨™ï¼Œç´„ 15 å­—): 
                    3. è—æ¨™å‹æ¨™é¡Œ (é•·æ¨™ï¼Œç´„ 25 å­—): æ¨™é¡Œå¸¶æœ‰æ‡¸å¿µï¼Œä¸å®Œå…¨é€éœ²äº‹ä»¶çµæœã€‚
                    4. è—æ¨™å‹æ¨™é¡Œ (çŸ­æ¨™ï¼Œç´„ 15 å­—): æ¨™é¡Œå¸¶æœ‰æ‡¸å¿µï¼Œä¸å®Œå…¨é€éœ²äº‹ä»¶çµæœã€‚
                    5. ç‰¹æ®Šå‹æ¨™é¡Œ (é•·æ¨™ï¼Œç´„ 25 å­—): æ¨™é¡Œä½¿ç”¨è«§éŸ³ã€æ¢—æˆ–æµè¡Œèªç­‰ç‰¹æ®Šæ‰‹æ³•ã€‚
                    6. ç‰¹æ®Šå‹æ¨™é¡Œ (çŸ­æ¨™ï¼Œç´„ 15 å­—): æ¨™é¡Œä½¿ç”¨è«§éŸ³ã€æ¢—æˆ–æµè¡Œèªç­‰ç‰¹æ®Šæ‰‹æ³•ã€‚

                    ### æ–°èç¨¿å…§å®¹ (News Content)
                    è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿ã€‚
                    `;
                    payload = { contents: [{ parts: [{ text: inputContent }] }], systemInstruction: { parts: [{ text: systemInstruction }] }, tools: [{ "google_search": {} }] };
                    break;

                case 'rewrite_link':
                    isGroundingEnabled = true;
                    loadingMessage.textContent = 'æ­£åœ¨æ”¹å¯«æ–°èï¼Œä¸¦ä»¥æ–°äº‹ä»¶å¡«è£œ 25-30% å…§å®¹...';
                    systemInstruction = `ä½ æ˜¯å°ˆæ¥­çš„å¨›æ¨‚æ–°èæ”¹å¯«ç·¨è¼¯ã€‚ä½ çš„ä»»å‹™æ˜¯æ”¹å¯«ç”¨æˆ¶æä¾›çš„åŸå§‹æ–°èå…¨æ–‡æˆ–é€£çµå…§å®¹ï¼Œä¸¦éµå¾ªä»¥ä¸‹åš´æ ¼è¦æ±‚ï¼š
                    1. è¼¸å‡ºå…­ç¨®æ¨™é¡Œï¼Œæ ¼å¼èˆ‡ã€Œé‡é»è½‰æ–°èã€æ¨¡å¼ç›¸åŒã€‚
                    2. è¼¸å‡ºç¸½æ®µè½æ•¸ï¼š**å›ºå®šç‚º 4 æ®µ**ã€‚
                    3. é¦–æ®µå­—æ•¸ï¼š**ä¸è¶…é 140 å­—**ã€‚
                    4. å…¶é¤˜æ®µè½å­—æ•¸ï¼š**ä»‹æ–¼ 130 å­—è‡³ 200 å­—ä¹‹é–“**ã€‚
                    5. **å°Šé‡åª’é«”**ï¼šæ”¹å¯«å…§å®¹çš„ç¬¬äºŒæ®µé¦–å¥å¿…é ˆè‘—åã€Œæ ¹æ“š${sourceName}å ±å°...ã€æˆ–é¡ä¼¼èªå¥ï¼Œä»¥ç¤ºå°ç«¶çˆ­åª’é«”çš„å°Šé‡ã€‚
                    6. **å…§å®¹æ›¿æ›**ï¼šæ”¹å¯«å…§å®¹**ä¸å¯å»¶ç”¨**åŸå§‹æ–°èé€£çºŒ 15 å­—ä»¥ä¸Šã€‚
                    7. **å…§å®¹è£œè¶³**ï¼š**å¿…é ˆ**åˆ©ç”¨å·²çŸ¥æ–°èèˆ‡äº‹ä»¶ï¼ˆé€é Grounding æœå°‹ï¼‰ä¾†å¡«è£œæˆ–å»¶ä¼¸ï¼Œç¢ºä¿æ”¹å¯«å…§å®¹ä¸­æœ‰ **25% åˆ° 30%** æ˜¯å…¨æ–°çš„è³‡è¨Šæˆ–è§€é»ã€‚

                    è«‹ä½¿ç”¨ Markdown æ ¼å¼è¼¸å‡ºã€Œæ¨™é¡Œåˆ—è¡¨ã€å’Œã€Œæ–°èç¨¿å…§å®¹ã€ã€‚
                    `;
                    // å°‡è¼¸å…¥å…§å®¹ä½œç‚ºæç¤ºè©çš„ä¸€éƒ¨åˆ†
                    const rewritePrompt = `è«‹æ ¹æ“šç³»çµ±æŒ‡ç¤ºï¼Œæ”¹å¯«ä»¥ä¸‹å…§å®¹ï¼š\n\n${inputContent}`;
                    payload = { contents: [{ parts: [{ text: rewritePrompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] }, tools: [{ "google_search": {} }] };
                    break;
                
                case 'rewrite_pr':
                    loadingMessage.textContent = 'æ­£åœ¨æ•´ç†å…¬é—œç¨¿ï¼Œé‡æ–°ç·¨æ’ä¸¦ç”Ÿæˆå…­æ¨™é¡Œ...';
                    systemInstruction = `ä½ æ˜¯è³‡æ·±çš„å¨›æ¨‚å…¬é—œç·¨è¼¯ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡å…¬é—œæä¾›çš„æ–°èç¨¿ä»¶é †ç¨¿ã€æ•´ç†é‡é»ï¼Œä¸¦é‡æ–°ç·¨æ’æˆä¸€ç¯‡å°ˆæ¥­çš„æ–°èã€‚å¦‚æœåŸæ–‡å…§å®¹å®Œæ•´ä¸”ç„¡è´…è©ï¼Œå¯ä»¥ç›´æ¥å…¨æ–‡ç…§ç™»ã€‚
                    
                    è«‹æ ¹æ“šä»¥ä¸‹åš´æ ¼è¦æ±‚è¼¸å‡ºï¼š
                    1. ç¸½æ®µè½æ•¸ï¼š**${paragraphCount}** æ®µã€‚
                    2. é¦–æ®µå­—æ•¸ï¼š**ä¸è¶…é 140 å­—**ã€‚
                    3. å…¶é¤˜æ®µè½å­—æ•¸ï¼š**ä»‹æ–¼ 130 å­—è‡³ 200 å­—ä¹‹é–“**ã€‚
                    
                    è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹å…­ç¨®æ¨™é¡Œåˆ†é¡å’Œä¸€ç¯‡æ–°èç¨¿å…§å®¹ä¾†è¼¸å‡ºçµæœï¼Œä½¿ç”¨ Markdown æ ¼å¼ï¼š
                    
                    ### æ¨™é¡Œåˆ—è¡¨ (Title List)
                    1. æ­£å¸¸å¨›æ¨‚æ¨™é¡Œ (é•·æ¨™ï¼Œç´„ 25 å­—): 
                    2. æ­£å¸¸å¨›æ¨‚æ¨™é¡Œ (çŸ­æ¨™ï¼Œç´„ 15 å­—): 
                    3. è—æ¨™å‹æ¨™é¡Œ (é•·æ¨™ï¼Œç´„ 25 å­—): 
                    4. è—æ¨™å‹æ¨™é¡Œ (çŸ­æ¨™ï¼Œç´„ 15 å­—): 
                    5. ç‰¹æ®Šå‹æ¨™é¡Œ (é•·æ¨™ï¼Œç´„ 25 å­—): 
                    6. ç‰¹æ®Šå‹æ¨™é¡Œ (çŸ­æ¨™ï¼Œç´„ 15 å­—): 

                    ### æ–°èç¨¿å…§å®¹ (News Content)
                    è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿ã€‚
                    `;
                    payload = { contents: [{ parts: [{ text: inputContent }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
                    break;

                case 'interview':
                    isGroundingEnabled = true;
                    loadingMessage.textContent = `æ­£åœ¨æœå°‹è—äººã€Œ${inputContent}ã€çš„è¿‘æœŸäº‹ä»¶ï¼Œæº–å‚™ 20 é¡Œæ·±åº¦è¨ªç¶±...`;
                    systemInstruction = `ä½ æ˜¯ç¶“é©—è±å¯Œçš„å¨›æ¨‚ç¯€ç›®è£½ä½œäººå’Œè¨ªè«‡å°ˆå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„è—äººåå–®ï¼ˆ${inputContent}ï¼‰åŠå…¶æ‰€æœ‰è¿‘æœŸçš„äº‹ä»¶ï¼ˆçˆ­è­°ã€è² é¢ã€æ­£é¢ã€æ–°ä½œå“ã€é–‹åº—ç­‰ï¼‰ç”Ÿæˆä¸€ä»½åŒ…å«**ç²¾ç¢º 20 é¡Œ**å•é¡Œçš„è¨ªç¶±ã€‚è¨ªç¶±å¿…é ˆæ¶µè“‹æ‰€æœ‰é—œéµè©±é¡Œï¼Œå•é¡Œæ‡‰å…·å‚™æ·±åº¦å’Œæ–°èæ€§ã€‚

                    è¼¸å‡ºæ ¼å¼ï¼šè«‹ç”¨ä¸­æ–‡ä»¥ Markdown åˆ—è¡¨æ ¼å¼è¼¸å‡ºé€™ 20 å€‹å•é¡Œã€‚
                    `;
                    const interviewPrompt = `è«‹æ ¹æ“šæ‚¨æ‰¾åˆ°çš„é—œæ–¼è—äººã€Œ${inputContent}ã€çš„æ‰€æœ‰è¿‘æœŸäº‹ä»¶èˆ‡æ–°èï¼Œç”Ÿæˆä¸€ä»½å…± 20 å€‹å•é¡Œçš„å®Œæ•´è¨ªç¶±ã€‚`;
                    payload = { contents: [{ parts: [{ text: interviewPrompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] }, tools: [{ "google_search": {} }] };
                    break;
            }

            // 3. UI ç‹€æ…‹åˆ‡æ›
            isProcessing = true;
            resultsDiv.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            citationContainer.classList.add('hidden');
            
            const button = document.getElementById('actionButton');
            if (button) {
                button.disabled = true;
                button.classList.add('opacity-50');
                button.textContent = 'è™•ç†ä¸­... è«‹ç¨å€™';
            }


            try {
                // 4. API å‘¼å«
                const response = await fetchWithRetry(apiUrlBase, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                // 5. è§£æçµæœ
                const candidate = result.candidates?.[0];
                let generatedText = "ç„¡æ³•å–å¾—å…§å®¹ã€‚";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;

                    // æå–ä¾†æº (å¦‚æœä½¿ç”¨ Grounding)
                    if (isGroundingEnabled) {
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                    }
                } else if (result.error) {
                    generatedText = `API éŒ¯èª¤: ${result.error.message}`;
                } else {
                    generatedText = "ç”Ÿæˆå…§å®¹çš„çµæ§‹ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚";
                }

                // 6. é¡¯ç¤ºçµæœå’Œä¾†æº
                displayResults(generatedText, sources, mode);

            } catch (error) {
                displayError(`${error.message}`);
                console.error("Fetch Error:", error);
            } finally {
                // 7. æ¢å¾© UI ç‹€æ…‹
                isProcessing = false;
                loadingIndicator.classList.add('hidden');
                if (button) {
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                    button.textContent = inputTemplates[mode].buttonText;
                }
            }
        }

        // --- é¡¯ç¤ºçµæœå’ŒéŒ¯èª¤ (å„ªåŒ–å€å¡Šï¼šçµæ§‹åŒ–è¼¸å‡º) ---
        function displayResults(text, sources, mode) {
            let htmlContent = '';
            
            // è™•ç†é€šç”¨ Markdown ç²—é«”
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            if (mode === 'news' || mode === 'rewrite_link' || mode === 'rewrite_pr') {
                
                // 1. æ ¹æ“š ### æ¨™é¡Œåˆ‡å‰²å…§å®¹
                const parts = text.split(/###\s*(.+?)\s*\n/); 
                let titleListContent = '';
                let newsContentBody = '';
                
                const titleListIndex = parts.findIndex(part => part.includes('æ¨™é¡Œåˆ—è¡¨'));
                if (titleListIndex !== -1 && titleListIndex + 1 < parts.length) {
                    titleListContent = parts[titleListIndex + 1];
                }
                
                const newsContentIndex = parts.findIndex(part => part.includes('æ–°èç¨¿å…§å®¹'));
                if (newsContentIndex !== -1 && newsContentIndex + 1 < parts.length) {
                    newsContentBody = parts[newsContentIndex + 1];
                }
                
                let titlesHtml = '';
                
                if (titleListContent) {
                    // 2. è™•ç† Titles: æå–æ¯ä¸€å€‹æ¨™é¡Œè¡Œï¼Œä¸¦å¥—ç”¨ grid layout
                    titlesHtml = titleListContent.replace(/(\d+\.\s*)([^:]+?:\s*)(.*?)(?:\n|$)/g, (match, number, type, title) => {
                        let typeText = type.replace(':', '').trim();
                        let typeClass = 'bg-gray-200 text-gray-800'; 

                        if (typeText.includes('æ­£å¸¸å¨›æ¨‚æ¨™é¡Œ') || typeText.includes('æ¨™æº–å¨›æ¨‚æ–°èæ¨™é¡Œ')) typeClass = 'bg-red-100 text-red-800';
                        else if (typeText.includes('è—æ¨™')) typeClass = 'bg-yellow-100 text-yellow-800';
                        else if (typeText.includes('ç‰¹æ®Šå‹æ¨™é¡Œ')) typeClass = 'bg-purple-100 text-purple-800';

                        return `
                            <div class="p-3 bg-white rounded-lg border border-gray-100 shadow-md flex flex-col space-y-2 hover:shadow-lg transition">
                                <div class="flex items-center">
                                    <span class="text-lg font-extrabold mr-3 text-gray-400">${number.replace('.', '')}</span>
                                    <span class="title-badge ${typeClass} whitespace-nowrap">${typeText}</span>
                                </div>
                                <p class="title-text text-base font-semibold pl-2 pt-1 leading-snug">${title.trim()}</p>
                            </div>
                        `;
                    });
                    
                    // ç¶²æ ¼ä½ˆå±€ï¼šmd:grid-cols-2
                    htmlContent += `
                        <h3 class="powerful-title">æ¨™é¡Œåˆ—è¡¨ (Title List)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${titlesHtml}
                        </div>
                    `;
                }
                
                let newsBodyHtml = '';
                if (newsContentBody) {
                    // 3. è™•ç† News Body: ä¾æ“šå…©æ¬¡ä»¥ä¸Šæ›è¡Œä¾†åˆ†å‰²æ®µè½ï¼Œä¸¦ç”¨ <p> æ¨™ç±¤åŒ…è£
                    const paragraphs = newsContentBody.trim().split(/\n\n+/).filter(p => p.trim() !== '');
                    newsBodyHtml = paragraphs.map(p => {
                        // ç¢ºä¿æ®µè½å…§çš„å–®æ¬¡æ›è¡Œè®Šæˆ <br>
                        const formattedParagraph = p.trim().replace(/\n/g, '<br>');
                        return `<p class="news-content text-gray-700">${formattedParagraph}</p>`;
                    }).join('');
                    
                    htmlContent += `
                        <h3 class="powerful-title">æ–°èç¨¿å…§å®¹ (News Content)</h3>
                        <div class="space-y-5 mt-4">
                            ${newsBodyHtml}
                        </div>
                    `;
                }
                
            } else if (mode === 'interview') {
                // Interview mode list logic
                htmlContent = text.replace(/###\s*(.+?)\s*\n/g, '<h3 class="powerful-title">$1</h3>');
                htmlContent = htmlContent.replace(/(\d+\.\s+)(.*?)(\n|$)/g, '<p class="mt-3 font-medium text-gray-800"><span class="text-purple-700 font-extrabold">$1</span>$2</p>');
            } else {
                // Default formatting for other modes
                htmlContent = text.replace(/\n/g, '<br>');
            }

            resultsDiv.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg">${htmlContent}</div>`;
            
            // é¡¯ç¤ºè³‡æ–™ä¾†æº
            if (sources.length > 0) {
                citationList.innerHTML = sources.map(source => 
                    `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline transition">${source.title || 'ç„¡æ¨™é¡Œ'}</a></li>`
                ).join('');
                citationContainer.classList.remove('hidden');
            } else {
                citationContainer.classList.add('hidden');
            }
        }

        function displayError(message) {
            resultsDiv.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center font-medium">${message}</div>`;
            citationContainer.classList.add('hidden');
        }

        // åˆå§‹åŒ–ï¼šé¦–æ¬¡è¼‰å…¥æ™‚æ¸²æŸ“é è¨­ä»‹é¢ (é‡é»è½‰æ–°è)
        document.addEventListener('DOMContentLoaded', () => {
            handleTabSwitch('news');
        });

    </script>
</body>
</html>